---
- name: Set the l_env
  set_fact:
    l_fw_command: "/ip firewall filter {{ item.value.operation }} {% if item.value.action is defined %}action={{item.value.action}} {% endif %}{% if item.value.connection_bytes is defined %}connection-bytes={{item.value.connection_bytes}} {% endif %}{% if item.value.connection_limit is defined %}connection-limit={{item.value.connection_limit}} {% endif %}{% if item.value.connection_mark is defined %}connection-mark={{item.value.connection_mark}} {% endif %}{% if item.value.connection_nat_state is defined %}connection-nat-state={{item.value.connection_nat_state}} {% endif %}{% if item.value.connection_rate is defined %}connection-rate={{item.value.connection_rate}} {% endif %}{% if item.value.connection_state is defined %}connection-state={{item.value.connection_state}} {% endif %}{% if item.value.connection_type is defined %}connection-type={{item.value.connection_type}} {% endif %}{% if item.value.dscp is defined %}dscp={{item.value.dscp}} {% endif %}{% if item.value.dst_limit is defined %}dst-limit={{item.value.dst_limit}} {% endif %}{% if item.value.icmp_options is defined %}icmp-options={{item.value.icmp_options}} {% endif %}{% if item.value.in_interface_list is defined %}in-interface-list=\"{{item.value.in_interface_list}}\" {% endif %}{% if item.value.jump_target is defined %}jump-target={{item.value.jump_target}} {% endif %}{% if item.value.log_prefix is defined %}log-prefix=\"{{item.value.log_prefix}}\" {% endif %}{% if item.value.out_interface is defined %}out-interface={{item.value.out_interface}} {% endif %}{% if item.value.packet_size is defined %}packet-size={{item.value.packet_size}} {% endif %}{% if item.value.priority is defined %}priority={{item.value.priority}} {% endif %}{% if item.value.reject_with is defined %}reject-with={{item.value.reject_with}} {% endif %}{% if item.value.src_address_list is defined %}src-address-list=\"{{item.value.src_address_list}}\" {% endif %}{% if item.value.tcp_flags is defined %}tcp-flags={{item.value.tcp_flags}} {% endif %}{% if item.value.ttl is defined %}ttl={{item.value.ttl}} {% endif %}{% if item.value.address_list is defined %}address-list=\"{{item.value.address_list}}\" {% endif %}{% if item.value.content is defined %}content={{item.value.content}} {% endif %}{% if item.value.dst_address is defined %}dst-address={{item.value.dst_address}} {% endif %}{% if item.value.dst_port is defined %}dst-port={{item.value.dst_port}} {% endif %}{% if item.value.in_bridge_port is defined %}in-bridge-port={{item.value.in_bridge_port}} {% endif %}{% if item.value.ingress_priority is defined %}ingress-priority={{item.value.ingress_priority}} {% endif %}{% if item.value.layer7_protocol is defined %}layer7-protocol={{item.value.layer7_protocol}} {% endif %}{% if item.value.nth is defined %}nth={{item.value.nth}} {% endif %}{% if item.value.out_interface_list is defined %}out-interface-list=\"{{item.value.out_interface_list}}\" {% endif %}{% if item.value.per_connection_classifier is defined %}per-connection-classifier={{item.value.per_connection_classifier}} {% endif %}{% if item.value.protocol is defined %}protocol={{item.value.protocol}} {% endif %}{% if item.value.routing_mark is defined %}routing-mark={{item.value.routing_mark}} {% endif %}{% if item.value.src_address_type is defined %}src-address-type={{item.value.src_address_type}} {% endif %}{% if item.value.tcp_mss is defined %}tcp-mss={{item.value.tcp_mss}} {% endif %}{% if item.value.chain is defined %}chain={{item.value.chain}} {% endif %}{% if item.value.address_list_timeout is defined %}address-list-timeout={{item.value.address_list_timeout}} {% endif %}{% if item.value.copy_from is defined %}copy-from={{item.value.copy_from}} {% endif %}{% if item.value.dst_address_list is defined %}dst-address-list=\"{{item.value.dst_address_list}}\" {% endif %}{% if item.value.fragment is defined %}fragment={{item.value.fragment}} {% endif %}{% if item.value.in_bridge_port_list is defined %}in-bridge-port-list=\"{{item.value.in_bridge_port_list}}\" {% endif %}{% if item.value.ipsec_policy is defined %}ipsec-policy={{item.value.ipsec_policy}} {% endif %}{% if item.value.limit is defined %}limit={{item.value.limit}} {% endif %}{% if item.value.out_bridge_port is defined %}out-bridge-port={{item.value.out_bridge_port}} {% endif %}{% if item.value.p2p is defined %}p2p={{item.value.p2p}} {% endif %}{% if item.value.place_before is defined %}place-before={{item.value.place_before}} {% endif %}{% if item.value.psd is defined %}psd={{item.value.psd}} {% endif %}{% if item.value.routing_table is defined %}routing-table={{item.value.routing_table}} {% endif %}{% if item.value.src_mac_address is defined %}src-mac-address={{item.value.src_mac_address}} {% endif %}{% if item.value.time is defined %}time={{item.value.time}} {% endif %}{% if item.value.comment is defined %}comment=\"{{item.value.comment}}\" {% endif %}{% if item.value.disabled is defined %}disabled={{item.value.disabled}} {% endif %}{% if item.value.dst_address_type is defined %}dst-address-type={{item.value.dst_address_type}} {% endif %}{% if item.value.hotspot is defined %}hotspot={{item.value.hotspot}} {% endif %}{% if item.value.in_interface is defined %}in-interface={{item.value.in_interface}} {% endif %}{% if item.value.ipv4_options is defined %}ipv4-options={{item.value.ipv4_options}} {% endif %}{% if item.value.log is defined %}log={{item.value.log}} {% endif %}{% if item.value.out_bridge_port_list is defined %}out-bridge-port-list=\"{{item.value.out_bridge_port_list}}\" {% endif %}{% if item.value.packet_mark is defined %}packet-mark={{item.value.packet_mark}} {% endif %}{% if item.value.port is defined %}port={{item.value.port}} {% endif %}{% if item.value.random is defined %}random={{item.value.random}} {% endif %}{% if item.value.src_address is defined %}src-address={{item.value.src_address}} {% endif %}{% if item.value.src_port is defined %}src-port={{item.value.src_port}} {% endif %}{% if item.value.tls_host is defined %}tls-host={{item.value.tls_host}} {% endif %} "
  with_dict: "{{ firewall_policies }}"
  when: item.key == firewall_policies_item.0

- name: Add firewall policy
  routeros_command:
    commands:
      - "{{ l_fw_command }}"
  with_dict: "{{ firewall_policies }}"
  when:
    - item.key == firewall_policies_item.0
    - __firewall_policies_output.stdout is not search(item.value.comment)

- name: Place firewall policy at correct place
  routeros_command:
    commands:
      - '/ip firewall filter move numbers=[find comment={{item.value.comment}} ] destination={{ __fw_rule_counter }}'
  with_dict: "{{ firewall_policies }}"
  when:
    - item.key == firewall_policies_item.0
#    - __firewall_policies_output.stdout is not search(item.value.comment)

- name: Set order for next firewall policy
  set_fact:
    __fw_rule_counter: "{{ __fw_rule_counter | int + 1 }}"
